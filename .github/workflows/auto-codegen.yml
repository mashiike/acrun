name: Auto-generate union type code

on:
  push:
    branches: [main]
    paths:
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: write
  pull-requests: write

jobs:
  codegen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5
        with:
          go-version: '1.25.3'

      - name: Run code generation
        run: go generate ./...

      - name: Check for changes
        id: git-check
        run: |
          if git diff --exit-code aws.gen.go aws.gen_test.go; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.git-check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate union type code after SDK update"
          branch: "auto/codegen-update"
          delete-branch: true
          title: "chore: Regenerate union type code after SDK update"
          body: |
            ## Summary

            This PR was automatically created because AWS SDK was updated in `go.mod`/`go.sum`
            and the codegen detected changes in union type variants.

            ## Changes

            - ðŸ¤– Regenerated `aws.gen.go`
            - ðŸ¤– Regenerated `aws.gen_test.go`

            ## What to check

            - [ ] Review the diff to ensure new variants are correctly detected
            - [ ] Verify all tests pass (CI will run automatically)
            - [ ] Check if any new enum values need special handling in `cmd/codegen/main.go`

            ## How this works

            1. Dependabot (or manual) updates AWS SDK in `go.mod`
            2. After merge to `main`, this workflow runs `go generate ./...`
            3. If `aws.gen.go` or `aws.gen_test.go` changed, this PR is created
            4. You review and merge this PR

            ---

            ðŸ¤– Auto-generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            dependencies
            auto-generated
