// Code generated by cmd/codegen. DO NOT EDIT.

package acrun

import (
	"bytes"
	"encoding/json"
	"fmt"

	"github.com/aws/aws-sdk-go-v2/service/bedrockagentcorecontrol"
	"github.com/aws/aws-sdk-go-v2/service/bedrockagentcorecontrol/types"
)
{{range .UnionFields}}
// convertTo{{.FieldName}} converts any value to types.{{.FieldName}}
func convertTo{{.FieldName}}(v any, strict bool) (types.{{.FieldName}}, error) {
	data, err := json.Marshal(v)
	if err != nil {
		return nil, err
	}
{{range .Members}}{{if .IsDirectValue}}
	// Try {{.JSONKey}} variant
	{
		dec := json.NewDecoder(bytes.NewReader(data))
		if strict {
			dec.DisallowUnknownFields()
		}
		var {{.JSONKey}}Variant struct {
			{{.JSONKey | toFieldName}} {{.ValueType}} {{.JSONTag}}
		}
		if err := dec.Decode(&{{.JSONKey}}Variant); err == nil {
			return &types.{{.TypeName}}{
				Value: {{.JSONKey}}Variant.{{.JSONKey | toFieldName}},
			}, nil
		}
	}
{{else}}
	// Try {{.JSONKey}} variant
	{
		dec := json.NewDecoder(bytes.NewReader(data))
		if strict {
			dec.DisallowUnknownFields()
		}
		var {{.JSONKey}}Variant struct {
			Field {{.ValueTypeShort}} {{.JSONTag}}
		}
		if err := dec.Decode(&{{.JSONKey}}Variant); err == nil {{if .ValueFields}}{{$member := .}}{{range .ValueFields}}{{if .IsPointer}}&& {{$member.JSONKey}}Variant.Field.{{.Name}} != nil{{end}}{{end}}{{end}} {
			return &types.{{.TypeName}}{
				Value: {{.JSONKey}}Variant.Field,
			}, nil
		}
	}
{{end}}{{end}}
	return nil, fmt.Errorf("no valid variant found for {{.FieldName}}")
}

// convertFrom{{.FieldName}} converts types.{{.FieldName}} to map[string]any
func convertFrom{{.FieldName}}(v types.{{.FieldName}}) (any, error) {
	if v == nil {
		return nil, nil
	}
	switch v := v.(type) {
{{range .Members}}	case *types.{{.TypeName}}:
{{if .IsDirectValue}}		return map[string]any{
			"{{.JSONKey}}": v.Value,
		}, nil
{{else}}		bs, err := marshalJSON(v.Value)
		if err != nil {
			return nil, err
		}
		return map[string]any{
			"{{.JSONKey}}": json.RawMessage(bs),
		}, nil
{{end}}{{end}}	default:
		return nil, fmt.Errorf("unknown {{.FieldName}} type: %T", v)
	}
}
{{end}}

func newAgentRuntimeFromResponse(out *bedrockagentcorecontrol.GetAgentRuntimeOutput) (*AgentRuntime, error) {
	bs, err := marshalJSON(out, func(opts *marshalJSONOptions) {
		opts.hooks = append(opts.hooks, func(path, key string, value any) (string, any, error) {
{{range .UnionFields}}			if matchJSONKey(path, "$.{{.FieldName | toLowerCamel}}") {
				v, err := convertFrom{{.FieldName}}(out.{{.FieldName}})
				if err != nil {
					return "", nil, err
				}
				return key, v, nil
			}
{{end}}			return key, value, nil
		})
		opts.ignoreLowerCamelPaths = append(opts.ignoreLowerCamelPaths,
			"$.environmentVariables.*",
		)
	})
	if err != nil {
		return nil, err
	}
	def, err := unmarshalAgentRuntime(bs, false)
	if err != nil {
		return nil, err
	}
	return def, nil
}

func newUpdateAgentRuntimeInput(out *bedrockagentcorecontrol.GetAgentRuntimeOutput, def *AgentRuntime) (*bedrockagentcorecontrol.UpdateAgentRuntimeInput, error) {
	var input bedrockagentcorecontrol.UpdateAgentRuntimeInput
	unmarshalOpts := func(opts *unmarshalJSONOptions) {
		opts.strict = false
		opts.hooks = append(opts.hooks, func(path, key string, value any) (string, any, error) {
{{range .UnionFields}}			if matchJSONKey(path, "$.{{.FieldName | toLowerCamel}}") {
				v, err := convertTo{{.FieldName}}(value, false)
				if err != nil {
					return "", nil, err
				}
				input.{{.FieldName}} = v
				return key, nil, nil
			}
{{end}}			return key, value, nil
		})
		opts.ignoreUpperCamelPaths = append(opts.ignoreUpperCamelPaths,
			"$.environmentVariables.*",
		)
	}
	// Override with the definition file
	bs, err := marshalAgentRuntime(def, "")
	if err != nil {
		return nil, err
	}
	if err := unmarshalJSON(bs, &input, unmarshalOpts); err != nil {
		return nil, err
	}
	input.AgentRuntimeId = out.AgentRuntimeId
	return &input, nil
}

func unmarshalAgentRuntime(bs []byte, strict bool) (*AgentRuntime, error) {
	var def AgentRuntime
	hook := func(path, key string, value any) (string, any, error) {
{{range .UnionFields}}		if matchJSONKey(path, "$.{{.FieldName | toLowerCamel}}") {
			v, err := convertTo{{.FieldName}}(value, strict)
			if err != nil {
				return "", nil, err
			}
			def.{{.FieldName}} = v
			return key, nil, nil
		}
{{end}}		return key, value, nil
	}
	if err := unmarshalJSON(bs, &def, func(opts *unmarshalJSONOptions) {
		opts.hooks = append(opts.hooks, hook)
		opts.strict = strict
		opts.ignoreUpperCamelPaths = append(opts.ignoreUpperCamelPaths,
			"$.environmentVariables.*",
		)
	}); err != nil {
		return nil, err
	}
	return &def, nil
}

func marshalAgentRuntime(v *AgentRuntime, indent string) ([]byte, error) {
	bs, err := marshalJSON(v, func(opts *marshalJSONOptions) {
		opts.hooks = append(opts.hooks, func(path, key string, value any) (string, any, error) {
{{range .UnionFields}}			if matchJSONKey(path, "$.{{.FieldName | toLowerCamel}}") {
				v, err := convertFrom{{.FieldName}}(v.{{.FieldName}})
				if err != nil {
					return "", nil, err
				}
				return key, v, nil
			}
{{end}}			return key, value, nil
		})
		opts.ignoreLowerCamelPaths = append(opts.ignoreLowerCamelPaths,
			"$.environmentVariables.*",
		)
	})
	if err != nil {
		return nil, err
	}
	if indent == "" {
		return bs, nil
	}
	var buf bytes.Buffer
	if err := json.Indent(&buf, bs, "", indent); err != nil {
		return nil, err
	}
	return buf.Bytes(), nil
}
